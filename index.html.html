<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD and GIS Support Cost Estimation Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f4f6f8; color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; 
            background: linear-gradient(180deg, #114b22 0%, #0a2e16 100%); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            padding: 25px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.15); 
            z-index: 100;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar h2 { font-size: 1.3em; margin-top: 0; margin-bottom: 25px; color: #fff; line-height: 1.4; border-bottom: 1px solid #2e6b3f; padding-bottom: 15px; }
        
        .nav-label { font-size: 0.75em; text-transform: uppercase; color: #8fd19e; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }
        
        .nav-btn { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid transparent; 
            color: #e8f5e9; 
            padding: 15px 20px; 
            text-align: left; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600; 
            border-radius: 8px; 
            margin-bottom: 12px; 
            transition: all 0.2s; 
            position: relative;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.15); transform: translateX(3px); }
        .nav-btn.active { 
            background: #ffffff; 
            color: #114b22; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            border-left: 6px solid #3ddc84;
        }
        .nav-badge {
            font-size: 0.8em;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            color: #a5d6a7;
        }
        .nav-btn.active .nav-badge { background: #e8f5e9; color: #114b22; font-weight: 800; }

        .reset-btn { margin-top: 10px; background: transparent; border: 1px solid #4caf50; color: #a5d6a7; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; width: 100%; transition: 0.2s; }
        .reset-btn:hover { background: rgba(76, 175, 80, 0.1); color: white; border-color: white; }
        
        .sidebar-bottom { margin-top: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 0; overflow-y: auto; background-color: #f4f6f8; padding-bottom: 140px; position: relative; }
        
        /* Sticky Header */
        .sticky-header {
            position: sticky; top: 0; z-index: 40;
            background: #fff; 
            padding: 25px 40px;
            border-bottom: 1px solid #dcdcdc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; gap: 20px;
        }

        .container { max-width: 950px; margin: 30px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.04); }
        
        /* --- TYPOGRAPHY & LAYOUT --- */
        h3 { color: #1e7e34; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 0; }
        .grid { display: grid; grid-template-columns: 2fr 1fr 0.8fr; gap: 25px; margin-bottom: 20px; align-items: center; border-bottom: 1px solid #f9f9f9; padding-bottom: 15px; }
        .grid:last-child { border-bottom: none; }
        
        .header-label { font-weight: bold; color: #888; text-transform: uppercase; font-size: 0.75em; letter-spacing: 0.5px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;}
        
        .section-title { 
            grid-column: span 3; 
            font-weight: bold; color: #114b22; 
            margin-top: 15px; margin-bottom: 15px;
            background: #e8f5e9; padding: 12px 18px; 
            border-radius: 8px; font-size: 1em; 
            border-left: 5px solid #28a745; 
            display: flex; align-items: center; gap: 12px; 
        }
        .section-title.clickable { cursor: pointer; transition: background 0.2s, transform 0.1s; user-select: none; }
        .section-title.clickable:hover { background: #dceddd; }
        .section-title.clickable:active { transform: scale(0.995); }

        label { font-weight: 600; font-size: 0.95em; color: #333; display: flex; align-items: center; gap: 8px; }
        .rate-display { font-size: 0.85em; color: #666; font-style: italic; display: flex; flex-direction: column;}
        
        /* --- INPUTS --- */
        input[type="number"], input[type="text"], select { 
            width: 100%; padding: 10px 12px; border: 1px solid #ced4da; 
            border-radius: 6px; font-size: 0.95em; transition: all 0.2s; box-sizing: border-box; 
            background: #fff;
        }
        input:focus, select:focus { border-color: #28a745; outline: none; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15); }
        
        .highlight-input { border: 2px solid #28a745 !important; background-color: #f0fff4; font-weight: bold; color: #1e7e34; }
        .error-input { border: 2px solid #dc3545 !important; background-color: #fff8f8 !important; animation: shake 0.3s; }
        
        /* --- TOGGLE SWITCH --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background-color: white;
            transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #28a745; }
        input:focus + .slider { box-shadow: 0 0 1px #28a745; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* --- TOOLTIPS --- */
        .tooltip-icon { 
            color: #17a2b8; cursor: help; font-size: 0.85em; font-weight: bold;
            background: rgba(23, 162, 184, 0.15); 
            width: 18px; height: 18px; border-radius: 50%; 
            display: inline-flex; align-items: center; justify-content: center;
        }
        .tooltip-wrapper { position: relative; display: inline-block; }
        .tooltip-text {
            visibility: hidden; width: 240px; background-color: #2d3436; color: #fff;
            text-align: left; border-radius: 6px; padding: 12px; font-size: 0.85em; font-weight: normal;
            line-height: 1.4;
            position: absolute; z-index: 100; bottom: 135%; left: 50%; margin-left: -120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); opacity: 0; transition: opacity 0.2s, bottom 0.2s;
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #2d3436 transparent transparent transparent;
        }
        .tooltip-wrapper:hover .tooltip-text { visibility: visible; opacity: 1; bottom: 125%; }

        /* --- FOOTER --- */
        .footer-bar { 
            position: fixed; bottom: 0; left: 280px; right: 0; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(5px);
            border-top: 1px solid #dcdcdc; 
            padding: 15px 40px; 
            display: flex; align-items: center; 
            justify-content: space-between; /* Distribute space */
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 50; 
        }

        /* 3-Column Footer Layout */
        .footer-left { flex: 1; } /* Spacer */
        
        .footer-center { 
            flex: 0 0 auto; /* Do not grow/shrink, fit content */
            display: flex; gap: 30px; 
            text-align: center; justify-content: center;
        }
        
        .footer-right { 
            flex: 1; /* Spacer to push buttons right */
            display: flex; justify-content: flex-end; gap: 12px; 
        }

        .res-item { text-align: center; }
        .res-item span { display: block; font-size: 1.8em; font-weight: 800; color: #1e7e34; line-height: 1; letter-spacing: -0.5px; }
        .res-item small { color: #888; font-size: 0.7em; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }

        .btn-action { 
            padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; font-size: 0.95em; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: all 0.2s; display: flex; align-items: center; gap: 8px; 
        }
        .btn-pdf { background: #b22222; color: white; }
        .btn-pdf:hover { background: #911b1b; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(178, 34, 34, 0.3); }
        .btn-copy { background: #fff; color: #333; border: 1px solid #ddd; }
        .btn-copy:hover { background: #f8f9fa; border-color: #bbb; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.05); }

        /* Utility */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-area { display: none; }
        .toggle-section { border: 2px dashed #ccc; padding: 25px; border-radius: 8px; margin-top: 15px; background: #fafafa; }
        .validation-msg { color: #dc3545; font-size: 0.8em; font-weight: bold; display: none; margin-top: 5px;}

        /* Customization Note */
        .custom-note {
            grid-column: span 3;
            background: #fff3e0;
            color: #e65100;
            font-size: 0.85em;
            font-style: italic;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
            margin-top: 10px;
        }

        /* Toast */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 12px; position: fixed;
            z-index: 200; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 0.9em; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>CAD and GIS Support<br>Estimator</h2>
    
    <div class="nav-label">Step 1: Select Category</div>
    <button class="nav-btn active" onclick="switchTab('cad', this)">
        CAD & Logs <span class="nav-badge" id="badge-cad">0h</span>
    </button>
    <button class="nav-btn" onclick="switchTab('gis', this)">
        GIS & Mapping <span class="nav-badge" id="badge-gis">0h</span>
    </button>
    
    <div class="sidebar-bottom">
        <label style="color:#e8f5e9; display:block; margin-bottom:8px; font-size:0.9em;">Support Rate ($/hr):</label>
        <input type="number" id="hourlyRate" value="90" disabled style="border:none; padding: 8px; font-weight: bold; background: rgba(255,255,255,0.9); color: #333;">
        <button class="reset-btn" onclick="resetForm()">&#8635; Start Over</button>
    </div>
</div>

<div class="main-content">
    <div class="sticky-header">
        <div style="flex: 2;">
            <label style="color: #1e7e34;">Project Name:</label>
            <input type="text" id="projectName" placeholder="Enter project reference...">
        </div>
        <div style="flex: 1;">
            <label style="color: #1e7e34;">Total Boring Footage:</label>
            <input type="number" id="totalFootage" value="0" oninput="calculate()" class="highlight-input">
            <div id="footageError" class="validation-msg">Required for Lab/Misc tasks!</div>
        </div>
        <div style="flex: 1;">
            <label style="color: #1e7e34;">Total Boring Count:</label>
            <input type="number" id="boringCount" value="0" oninput="calculate()" class="highlight-input">
        </div>
    </div>

    <div class="container">
        <div id="tab-cad" class="tab-content active">
            <div class="grid">
                <div class="header-label">Task Description</div>
                <div class="header-label">Rate Logic</div>
                <div class="header-label">Qty / Select</div>

                <div class="section-title">Boring Logs (gINT)</div>
                
                <label>
                    Initial Boring Processing
                    <div class="tooltip-wrapper">
                        <div class="tooltip-icon">i</div>
                        <div class="tooltip-text">Includes data entry from field logs, formatting templates, and initial QA/QC.</div>
                    </div>
                </label>
                <div class="rate-display">0.25 hr/boring</div>
                <div class="rate-display" id="disp-boringProc" style="color:#28a745; font-weight:bold;">0.00 hrs</div>

                <label>Incorporate Lab Data</label>
                <div class="rate-display">1.5 min/ft</div>
                <label class="switch">
                    <input type="checkbox" id="includeLab" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>Miscellaneous gINT Edits</label>
                <div class="rate-display">1.5 min/ft</div>
                <label class="switch">
                    <input type="checkbox" id="includeMisc" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <div class="section-title">Drafting & Figures</div>

                <label>Cross Sections</label>
                <div class="rate-display">6hr + 0.1/brg (>6)</div>
                <input type="number" id="xsCount" value="0" oninput="calculate()" placeholder="Qty">

                <label>Profiles</label>
                <div class="rate-display">6hr + 0.1/brg (>6)</div>
                <input type="number" id="profileCount" value="0" oninput="calculate()" placeholder="Qty">

                <label>Site Exploration Plan</label>
                <div class="rate-display">6 hr/figure</div>
                <input type="number" id="sepCount" value="0" oninput="calculate()" placeholder="Qty">

                <label>Earth Pressure Diagram</label>
                <div class="rate-display">6hr (1st) + 2hr (addl)</div>
                <input type="number" id="epdCount" value="0" oninput="calculate()" placeholder="Qty">

                <label>ESU Lab Data Summary</label>
                <div class="rate-display">6hr + 0.1/brg (>6)</div>
                <label class="switch">
                    <input type="checkbox" id="includeESU" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>gINT Table/Fence Diagram</label>
                <div class="rate-display">1 hr/figure</div>
                <input type="number" id="fenceCount" value="0" oninput="calculate()" placeholder="Qty">
            </div>
        </div>

        <div id="tab-gis" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div style="font-style:italic; color:#666;">Configure GIS/Mapping tasks based on project needs.</div>
                <div style="background:#eef9f1; padding:10px; border-radius:6px; border:1px solid #c3e6cb;">
                    <label style="margin-right:10px; color:#1e7e34;">Complexity:</label>
                    <select id="gisComplexity" onchange="calculate()" style="width: auto; padding: 5px; border:1px solid #28a745;">
                        <option value="standard">Standard (Lower Range)</option>
                        <option value="complex">Complex/Large (Upper Range)</option>
                    </select>
                </div>
            </div>

            <div class="grid">
                <div class="header-label">Map / Task</div>
                <div class="header-label">Rate Logic</div>
                <div class="header-label">Include?</div>

                <div class="section-title">Standard Maps</div>

                <label>Field Exploration Map</label>
                <div class="rate-display"><span>2-4 hrs</span><span>(Incrs if >10 Brg)</span></div>
                <label class="switch">
                    <input type="checkbox" id="gisExploration" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>
                    Staked Borings Map
                    <div class="tooltip-wrapper">
                        <div class="tooltip-icon">i</div>
                        <div class="tooltip-text">This map is prepared after the drill crew has staked the borings. For projects involving drilling, this map is always completed.</div>
                    </div>
                </label>
                <div class="rate-display"><span>2-4 hrs</span><span>(Incrs if >10 Brg)</span></div>
                <label class="switch">
                    <input type="checkbox" id="gisStaked" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>Site Vicinity Map</label>
                <div class="rate-display">2 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gisVicinity" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>Geology Map</label>
                <div class="rate-display">4 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gisGeology" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>Site Map</label>
                <div class="rate-display">2-4 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gisSiteMap" onchange="calculate()">
                    <span class="slider"></span>
                </label>
                
                <label>Fault Map</label>
                <div class="rate-display">4 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gisFault" onchange="calculate()">
                    <span class="slider"></span>
                </label>
                
                <label>Lidar & Field Data Map</label>
                <div class="rate-display">4 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gisLidarMap" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>
                    Field Map Offline/Add Data
                    <div class="tooltip-wrapper">
                        <div class="tooltip-icon">i</div>
                        <div class="tooltip-text">Setup for tablets/mobile use in areas with no cell service.</div>
                    </div>
                </label>
                <div class="rate-display">6 hrs total</div>
                <label class="switch">
                    <input type="checkbox" id="gisFieldMap" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <label>4 Pane Lidar Map</label>
                <div class="rate-display">4 hrs</div>
                <label class="switch">
                    <input type="checkbox" id="gis4Pane" onchange="calculate()">
                    <span class="slider"></span>
                </label>

                <div class="custom-note">
                    *Any customization to the standard maps will add hours.
                </div>
            </div>

            <div class="section-title clickable" onclick="toggleHistorical()">
                <input type="checkbox" id="histMasterToggle" onchange="toggleHistorical()" style="width:20px; height:20px;">
                Include Historical Borings Not Found in WebMap?
            </div>

            <div id="historicalContent" class="hidden-area toggle-section">
                <div class="grid">      
                    <label>How many Historical Borings?</label>
                    <div class="rate-display"><span>From all sources</span></div>
                    <input type="number" id="histBoringQty" value="0" oninput="calculate()" placeholder="Total count">

                    <label>How many Source Plan Sheets?</label>
                    <div class="rate-display"><span>Files to reference</span></div>
                    <input type="number" id="histSheetQty" value="0" oninput="calculate()" placeholder="Total sheets">
                    
                    <label>Who locates/downloads logs?</label>
                    <div class="rate-display"><span>Research Effort</span></div>
                    <select id="histIncludeResearch" onchange="calculate()">
                        <option value="no">PM/Other (Files Provided)</option>
                        <option value="yes">GIS Team (Research Needed)</option>
                    </select>
                </div>
            </div>

            <div class="section-title clickable" onclick="toggleLidar()">
                <input type="checkbox" id="lidarMasterToggle" onchange="toggleLidar()" style="width:20px; height:20px;">
                Include Lidar Analysis Tasks?
            </div>
            
            <div id="lidarContent" class="hidden-area toggle-section">
                <div class="grid">
                    <label>Change Analysis</label>
                    <div class="rate-display">4 hrs / file</div>
                    <input type="number" id="lidarChangeFiles" value="0" oninput="calculate()" placeholder="# Files">

                    <label>Lidar Prep & Completion</label>
                    <div class="rate-display">10-20 hrs / file</div>
                    <input type="number" id="lidarPrepFiles" value="0" oninput="calculate()" placeholder="# Files">
                </div>
            </div>

            <div class="section-title clickable" onclick="toggle3D()">
                <input type="checkbox" id="3DMasterToggle" onchange="toggle3D()" style="width:20px; height:20px;">
                Include 3D Analysis?
            </div>

            <div id="3DContent" class="hidden-area toggle-section">
                <div class="grid">
                    <label>Surface Profiles</label>
                    <div class="rate-display">4 hrs / section</div>
                    <input type="number" id="gisSurfaceProf" value="0" oninput="calculate()" placeholder="# Sections">
                    
                    <label>3D Surface</label>
                    <div class="rate-display">8 hrs / surface</div>
                    <input type="number" id="gis3DSurf" value="0" oninput="calculate()" placeholder="# Surfaces">

                    <label>Viewshed</label>
                    <div class="rate-display">8 hrs / view</div>
                    <input type="number" id="gisViewshed" value="0" oninput="calculate()" placeholder="Qty">

                    <label>Steepest Slope/Flow</label>
                    <div class="rate-display">2 hrs / analysis</div>
                    <input type="number" id="gisSlope" value="0" oninput="calculate()" placeholder="Qty">
                </div>
            </div>
        </div>
        
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 0.8em; color: #888; font-style: italic;">
             These hours are preliminary estimates and may increase based on project complexity.
        </div>
    </div>
</div>

<div class="footer-bar">
    <div class="footer-left"></div> <div class="footer-center">
        <div class="res-item">
            <span id="grandTotalHours">0.00</span>
            <small>Total Hours</small>
        </div>
        <div class="res-item">
            <span id="grandTotalCost">$0.00</span>
            <small>Est. Cost</small>
        </div>
    </div>

    <div class="footer-right">
        <button class="btn-action btn-copy" onclick="copySummary()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Copy Summary
        </button>
        <button class="btn-action btn-pdf" onclick="savePDF()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            Save PDF
        </button>
    </div>
</div>

<div id="toast">Copied to clipboard!</div>

<script>
    const MINS_PER_FT = 1.5;

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        btn.classList.add('active');
    }

    function toggleLidar() {
        const box = document.getElementById('lidarMasterToggle');
        const content = document.getElementById('lidarContent');
        if (event.target !== box) box.checked = !box.checked;
        box.checked ? content.classList.remove('hidden-area') : content.classList.add('hidden-area');
        if(!box.checked) { document.getElementById('lidarChangeFiles').value = 0; document.getElementById('lidarPrepFiles').value = 0; }
        calculate();
    }

    function toggleHistorical() {
        const box = document.getElementById('histMasterToggle');
        const content = document.getElementById('historicalContent');
        if (event.target !== box) box.checked = !box.checked;
        box.checked ? content.classList.remove('hidden-area') : content.classList.add('hidden-area');
        if(!box.checked) { document.getElementById('histBoringQty').value = 0; document.getElementById('histSheetQty').value = 0; }
        calculate();
    }

    function toggle3D() {
        const box = document.getElementById('3DMasterToggle');
        const content = document.getElementById('3DContent');
        if (event.target !== box) box.checked = !box.checked;
        box.checked ? content.classList.remove('hidden-area') : content.classList.add('hidden-area');
        if(!box.checked) {
             document.getElementById('gisSurfaceProf').value = 0;
             document.getElementById('gis3DSurf').value = 0;
             document.getElementById('gisViewshed').value = 0;
             document.getElementById('gisSlope').value = 0;
        }
        calculate();
    }

    function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
    // UPDATED: Now checks for checkboxes (switch) or standard yes/no select
    function isYes(id) { 
        const el = document.getElementById(id);
        if (el.type === 'checkbox') return el.checked;
        return el.value === 'yes'; 
    }

    function resetForm() {
        if(confirm("Clear all data and start over?")) {
            location.reload();
        }
    }

    function calculate() {
        const rate = 90;
        const borings = getVal('boringCount');
        const footage = getVal('totalFootage');
        
        // --- VALIDATION ---
        const needsFootage = isYes('includeLab') || isYes('includeMisc');
        const footageInput = document.getElementById('totalFootage');
        const footageError = document.getElementById('footageError');
        
        if(needsFootage && footage === 0) {
            footageInput.classList.add('error-input');
            footageError.style.display = 'block';
        } else {
            footageInput.classList.remove('error-input');
            footageError.style.display = 'none';
        }
        
        // --- CAD ---
        const extraBoringTime = borings > 6 ? (borings - 6) * 0.1 : 0;
        let cadHours = 0;
        
        const boringProc = borings * 0.25;
        document.getElementById('disp-boringProc').innerText = boringProc.toFixed(2) + ' hrs';
        cadHours += boringProc;
        
        if(isYes('includeLab')) cadHours += footage * (MINS_PER_FT / 60);
        if(isYes('includeMisc')) cadHours += footage * (MINS_PER_FT / 60);
        
        const xsQty = getVal('xsCount'); if(xsQty > 0) cadHours += (xsQty * 6) + extraBoringTime;
        const profQty = getVal('profileCount'); if(profQty > 0) cadHours += (profQty * 6) + extraBoringTime;
        cadHours += getVal('sepCount') * 6;
        const epdQty = getVal('epdCount'); if(epdQty > 0) cadHours += 6 + ((epdQty - 1) * 2);
        if(isYes('includeESU')) cadHours += 6 + extraBoringTime;
        cadHours += getVal('fenceCount') * 1;

        // --- GIS ---
        let gisHours = 0;
        const isComplex = document.getElementById('gisComplexity').value === 'complex';
        const getRange = (low, high) => isComplex ? high : low;
        const highVolSurcharge = borings > 10 ? 2 : 0;
        
        if(isYes('gisExploration')) gisHours += getRange(2, 4) + highVolSurcharge;
        if(isYes('gisStaked')) gisHours += getRange(2, 4) + highVolSurcharge;
        if(isYes('gisVicinity')) gisHours += 2;
        if(isYes('gisGeology')) gisHours += 4;
        if(isYes('gisSiteMap')) gisHours += getRange(2, 4);
        if(isYes('gisFault')) gisHours += 4;
        if(isYes('gisLidarMap')) gisHours += 4;
        if(isYes('gisFieldMap')) gisHours += 6;

        // New Item Toggle
        if(isYes('gis4Pane')) gisHours += 4;

        // Hist
        let histTotal = 0;
        const histBoringQty = getVal('histBoringQty');
        const histSheetQty = getVal('histSheetQty');
        const doResearch = isYes('histIncludeResearch');

        if (histBoringQty > 0 || histSheetQty > 0) {
            histTotal += 0.5; // script
            histTotal += histBoringQty * (20 / 60); // entry
            histTotal += histSheetQty * 1.0; // georef
            if (doResearch) histTotal += (histSheetQty * 1.0);
        }
        gisHours += histTotal;

        // Lidar
        gisHours += getVal('lidarChangeFiles') * 4;
        gisHours += getVal('lidarPrepFiles') * getRange(10, 20);

        // 3D
        gisHours += getVal('gisSurfaceProf') * 4;
        gisHours += getVal('gis3DSurf') * 8;
        gisHours += getVal('gisViewshed') * 8;
        gisHours += getVal('gisSlope') * 2;

        // --- TOTALS ---
        const totalHours = cadHours + gisHours;
        const totalCost = totalHours * rate;

        document.getElementById('grandTotalHours').innerText = totalHours.toFixed(2);
        document.getElementById('grandTotalCost').innerText = '$' + totalCost.toLocaleString(undefined, {minimumFractionDigits: 2});

        // Update Sidebar Badges
        document.getElementById('badge-cad').innerText = cadHours.toFixed(1) + 'h';
        document.getElementById('badge-gis').innerText = gisHours.toFixed(1) + 'h';

        return { cadHours, gisHours, totalHours, totalCost, rate, borings, footage, histBoringQty, histSheetQty, histTotal, doResearch };
    }

    function copySummary() {
        const d = calculate();
        const proj = document.getElementById('projectName').value || "Project";
        const text = `
Estimate Summary for: ${proj}
-----------------------------
Total CAD Hours: ${d.cadHours.toFixed(2)}
Total GIS Hours: ${d.gisHours.toFixed(2)}
-----------------------------
GRAND TOTAL: ${d.totalHours.toFixed(2)} Hours
ESTIMATE COST: $${d.totalCost.toLocaleString(undefined, {minimumFractionDigits: 2})}
        `.trim();

        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('toast');
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        });
    }

    function savePDF() {
        const d = calculate();
        const proj = document.getElementById('projectName').value || "Project";
        const date = new Date().toLocaleDateString();
        
        let cadItems = [];
        let gisItems = [];

        // Helper to add row
        const addRow = (list, name, detail, hrs) => {
            if(hrs > 0) list.push(`
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:6px 0;">${name}</td>
                    <td style="padding:6px 0; color:#666; font-size:0.9em;">${detail}</td>
                    <td style="padding:6px 0; text-align:right; font-weight:bold;">${hrs.toFixed(2)}</td>
                </tr>
            `);
        };

        // CAD Items
        addRow(cadItems, "Initial Boring Processing", `${d.borings} borings`, d.borings * 0.25);
        if(isYes('includeLab')) addRow(cadItems, "Incorporate Lab Data", "Yes", d.footage * (1.5/60));
        if(isYes('includeMisc')) addRow(cadItems, "Misc gINT Edits", "Yes", d.footage * (1.5/60));
        const xs = getVal('xsCount'); if(xs>0) addRow(cadItems, "Cross Sections", `${xs}`, (xs*6) + (d.borings>6?(d.borings-6)*0.1:0));
        const pro = getVal('profileCount'); if(pro>0) addRow(cadItems, "Profiles", `${pro}`, (pro*6) + (d.borings>6?(d.borings-6)*0.1:0));
        const sep = getVal('sepCount'); if(sep>0) addRow(cadItems, "Site Exploration Plan", `${sep}`, sep*6);
        const epd = getVal('epdCount'); if(epd>0) addRow(cadItems, "Earth Pressure Diagram", `${epd}`, 6 + ((epd-1)*2));
        if(isYes('includeESU')) addRow(cadItems, "ESU Lab Summary", "Yes", 6 + (d.borings>6?(d.borings-6)*0.1:0));
        const fen = getVal('fenceCount'); if(fen>0) addRow(cadItems, "Fence Diagrams", `${fen}`, fen);

        // GIS Items
        const isComplex = document.getElementById('gisComplexity').value === 'complex';
        const cplxTag = isComplex ? "(Complex)" : "(Std)";
        if(isYes('gisExploration')) addRow(gisItems, "Field Exploration Map", "Yes", getVal('boringCount')>10 ? (isComplex?6:4) : (isComplex?4:2));
        if(isYes('gisStaked')) addRow(gisItems, "Staked Borings Map", "Yes", getVal('boringCount')>10 ? (isComplex?6:4) : (isComplex?4:2));
        if(isYes('gisVicinity')) addRow(gisItems, "Site Vicinity Map", "Yes", 2);
        if(isYes('gisGeology')) addRow(gisItems, "Geology Map", "Yes", 4);
        if(isYes('gisSiteMap')) addRow(gisItems, "Site Map", "Yes", isComplex?4:2);
        if(isYes('gisFault')) addRow(gisItems, "Fault Map", "Yes", 4);
        if(isYes('gisLidarMap')) addRow(gisItems, "Lidar & Field Data Map", "Yes", 4);
        if(isYes('gisFieldMap')) addRow(gisItems, "Field Map Setup", "Yes", 6);
        
        if(isYes('gis4Pane')) addRow(gisItems, "4 Pane Lidar", "Yes", 4);

        if(d.histTotal > 0) {
            let geoRefHours = (d.histSheetQty * 1) + (d.doResearch ? (d.histSheetQty * 1) : 0);
            if(geoRefHours > 0) addRow(gisItems, "Hist. Georeferencing", `${d.histSheetQty} sheets`, geoRefHours);
            let entryHours = 0.5 + (d.histBoringQty * (20/60));
            addRow(gisItems, "Hist. Data Entry", `${d.histBoringQty} borings`, entryHours);
        }

        const lChan = getVal('lidarChangeFiles'); if(lChan>0) addRow(gisItems, "Lidar Change Analysis", `${lChan} files`, lChan*4);
        const lPrep = getVal('lidarPrepFiles'); if(lPrep>0) addRow(gisItems, "Lidar Prep", `${lPrep} files`, lPrep*(isComplex?20:10));
        const surf = getVal('gisSurfaceProf'); if(surf>0) addRow(gisItems, "Surface Profiles", `${surf} sections`, surf*4);
        const d3 = getVal('gis3DSurf'); if(d3>0) addRow(gisItems, "3D Surface", `${d3} surfaces`, d3*8);
        const view = getVal('gisViewshed'); if(view>0) addRow(gisItems, "Viewshed", `${view} qty`, view*8);
        const slp = getVal('gisSlope'); if(slp>0) addRow(gisItems, "Steepest Slope/Flow", `${slp} qty`, slp*2);

        // --- PDF LAYOUT (TWO COLUMNS) ---
        let reportHTML = `
            <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #333; background: #fff;">
                
                <div style="border-bottom: 3px solid #114b22; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <h1 style="margin: 0; font-size: 24px; color: #114b22;">Support Cost Estimate</h1>
                        <div style="font-size: 14px; color: #666;">Geotech CAD & GIS Services</div>
                    </div>
                    <div style="text-align: right; font-size: 13px; color: #555;">
                        <div><strong>Date:</strong> ${date}</div>
                        <div><strong>Project:</strong> ${proj}</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 10px 15px; border-radius: 4px; margin-bottom: 25px; font-size: 13px; display: flex; justify-content: space-between; font-weight: bold;">
                    <span>Scope: ${d.borings} Borings</span>
                    <span>Footage: ${d.footage} ft</span>
                    <span>Rate: $90.00/hr</span>
                </div>

                <div style="display: flex; gap: 30px; align-items: flex-start;">
                    
                    <div style="flex: 1;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #28a745; border-bottom: 1px solid #28a745; padding-bottom: 5px;">CAD Tasks</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="color: #888; font-size: 10px; text-transform: uppercase;">
                                    <th style="text-align:left; padding:5px 0;">Task</th>
                                    <th style="text-align:left; padding:5px 0;">Qty/Detail</th>
                                    <th style="text-align:right; padding:5px 0;">Hrs</th>
                                </tr>
                            </thead>
                            <tbody>${cadItems.length ? cadItems.join('') : '<tr><td colspan="3" style="padding:10px; text-align:center; color:#999;">No CAD tasks selected</td></tr>'}</tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background: #f0fff4;">
                                    <td colspan="2" style="padding: 8px 0;">CAD Subtotal</td>
                                    <td style="padding: 8px 0; text-align: right;">${d.cadHours.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div style="flex: 1;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #17a2b8; border-bottom: 1px solid #17a2b8; padding-bottom: 5px;">GIS Tasks</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="color: #888; font-size: 10px; text-transform: uppercase;">
                                    <th style="text-align:left; padding:5px 0;">Task</th>
                                    <th style="text-align:left; padding:5px 0;">Qty/Detail</th>
                                    <th style="text-align:right; padding:5px 0;">Hrs</th>
                                </tr>
                            </thead>
                            <tbody>${gisItems.length ? gisItems.join('') : '<tr><td colspan="3" style="padding:10px; text-align:center; color:#999;">No GIS tasks selected</td></tr>'}</tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background: #f0fcff;">
                                    <td colspan="2" style="padding: 8px 0;">GIS Subtotal</td>
                                    <td style="padding: 8px 0; text-align: right;">${d.gisHours.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>

                <div style="margin-top: 30px; border-top: 2px solid #333; padding-top: 15px; display: flex; justify-content: flex-end; page-break-inside: avoid;">
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: #555;">Total Hours: <strong>${d.totalHours.toFixed(2)}</strong></div>
                        <div style="font-size: 22px; color: #114b22; font-weight: 800; margin-top: 5px;">$${d.totalCost.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                    </div>
                </div>

                <div style="margin-top: 40px; font-size: 10px; color: #999; font-style: italic; text-align: center; border-top: 1px solid #eee; padding-top: 10px; page-break-inside: avoid;">
                    These hours are preliminary estimates and may increase based on project complexity or if additional information is needed and requires coordination with the PEO.
                </div>
            </div>`;

        const element = document.createElement('div');
        element.innerHTML = reportHTML;
        html2pdf().set({ margin: 0.5, filename: `${proj.replace(/\s+/g, '_')}_Estimate.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }).from(element).save();
    }
</script>

</body>
</html>